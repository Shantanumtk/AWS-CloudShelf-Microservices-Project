name: ci-pipeline

on:
  push:
    branches: [ github-actions ]
    paths:
      - 'spring-microservices-bookstore-demo/**'
      - '.github/workflows/ci-pipeline.yml'
  workflow_dispatch:

env:
  ROOT_DIR: spring-microservices-bookstore-demo
  DOCKERHUB_NAMESPACE: shpro123

jobs:
  build-backend-jars:
    name: Maven package (all Java services)
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: Maven package (skip tests)
        working-directory: ${{ env.ROOT_DIR }}
        run: mvn -B -DskipTests package

      - name: Upload JARs for downstream jobs
        uses: actions/upload-artifact@v4
        with:
          name: built-jars
          path: |
            spring-microservices-bookstore-demo/discovery-server/target/*.jar
            spring-microservices-bookstore-demo/config-server/target/*.jar
            spring-microservices-bookstore-demo/api-gateway/target/*.jar
            spring-microservices-bookstore-demo/book-service/target/*.jar
            spring-microservices-bookstore-demo/author-service/target/*.jar
            spring-microservices-bookstore-demo/order-service/target/*.jar
            spring-microservices-bookstore-demo/stock-check-service/target/*.jar
            spring-microservices-bookstore-demo/message-service/target/*.jar

  dockerize-backends:
    name: Build & Push backend images
    runs-on: ubuntu-latest
    needs: build-backend-jars
    strategy:
      fail-fast: false
      matrix:
        svc:
          - discovery-server
          - config-server
          - api-gateway
          - book-service
          - author-service
          - order-service
          - stock-check-service
          - message-service
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Restore JARs
        uses: actions/download-artifact@v4
        with:
          name: built-jars
          # No 'path' -> preserves original directories under repo root

      - name: Compute short SHA
        id: vars
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          echo "sha_tag=sha-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image name and tags
        id: meta
        run: |
          IMAGE=${{ env.DOCKERHUB_NAMESPACE }}/${{ matrix.svc }}
          echo "image=${IMAGE}" >> $GITHUB_OUTPUT
          echo "tags=${IMAGE}:latest,${IMAGE}:${{ steps.vars.outputs.sha_tag }}" >> $GITHUB_OUTPUT

      - name: Build & Push ${{ matrix.svc }}
        uses: docker/build-push-action@v6
        with:
          context: ./${{ env.ROOT_DIR }}/${{ matrix.svc }}
          file: ./${{ env.ROOT_DIR }}/${{ matrix.svc }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache,mode=max
