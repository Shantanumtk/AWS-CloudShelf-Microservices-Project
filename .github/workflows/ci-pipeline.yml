name: ci-pipeline

on:
  push:
    branches: [ github-actions ]
    paths:
      - 'spring-microservices-bookstore-demo/**'
      - '.github/workflows/ci-pipeline.yml'

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-backend-jars:
    name: Maven package (all Java services)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: spring-microservices-bookstore-demo
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Temurin JDK 17 with Maven cache
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
          cache: maven

      - name: mvn -B -DskipTests package
        run: mvn -B -DskipTests package

      - name: Upload discovery-server jar
        uses: actions/upload-artifact@v4
        with:
          name: discovery-server-jar
          path: spring-microservices-bookstore-demo/discovery-server/target/*.jar
          if-no-files-found: error

      - name: Upload config-server jar
        uses: actions/upload-artifact@v4
        with:
          name: config-server-jar
          path: spring-microservices-bookstore-demo/config-server/target/*.jar
          if-no-files-found: error

      - name: Upload api-gateway jar
        uses: actions/upload-artifact@v4
        with:
          name: api-gateway-jar
          path: spring-microservices-bookstore-demo/api-gateway/target/*.jar
          if-no-files-found: error

      - name: Upload book-service jar
        uses: actions/upload-artifact@v4
        with:
          name: book-service-jar
          path: spring-microservices-bookstore-demo/book-service/target/*.jar
          if-no-files-found: error

      - name: Upload author-service jar
        uses: actions/upload-artifact@v4
        with:
          name: author-service-jar
          path: spring-microservices-bookstore-demo/author-service/target/*.jar
          if-no-files-found: error

      - name: Upload order-service jar
        uses: actions/upload-artifact@v4
        with:
          name: order-service-jar
          path: spring-microservices-bookstore-demo/order-service/target/*.jar
          if-no-files-found: error

      - name: Upload stock-check-service jar
        uses: actions/upload-artifact@v4
        with:
          name: stock-check-service-jar
          path: spring-microservices-bookstore-demo/stock-check-service/target/*.jar
          if-no-files-found: error

      - name: Upload message-service jar
        uses: actions/upload-artifact@v4
        with:
          name: message-service-jar
          path: spring-microservices-bookstore-demo/message-service/target/*.jar
          if-no-files-found: error

  dockerize-backends:
    name: Build & Push backend images
    runs-on: ubuntu-latest
    needs: build-backend-jars
    strategy:
      fail-fast: false
      matrix:
        svc:
          - discovery-server
          - config-server
          - api-gateway
          - book-service
          - author-service
          - order-service
          - stock-check-service
          - message-service
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download JAR artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.svc }}-jar
          path: spring-microservices-bookstore-demo/${{ matrix.svc }}/target

      - name: Sanity check service layout & JAR
        run: |
          root="spring-microservices-bookstore-demo"
          svc="${{ matrix.svc }}"
          test -f "$root/$svc/Dockerfile" || { echo "Missing $root/$svc/Dockerfile"; exit 1; }
          test -f "$root/$svc/pom.xml"    || { echo "Missing $root/$svc/pom.xml"; exit 1; }
          test -d "$root/$svc/src"        || { echo "Missing $root/$svc/src/"; exit 1; }
          ls -l "$root/$svc/target"/*.jar || { echo "No JAR in $root/$svc/target"; exit 1; }
          echo "Layout & JAR OK for $svc"

      - name: Compute short SHA
        id: vars
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Compute image name and tags
        id: meta
        run: |
          IMAGE="shpro123/${{ matrix.svc }}"
          echo "image=${IMAGE}" >> "$GITHUB_OUTPUT"
          echo "tags=${IMAGE}:latest,${IMAGE}:${{ steps.vars.outputs.sha_tag }}" >> "$GITHUB_OUTPUT"

      - name: Build & Push ${{ matrix.svc }}
        uses: docker/build-push-action@v6
        with:
          context: ./spring-microservices-bookstore-demo/${{ matrix.svc }}
          file: ./spring-microservices-bookstore-demo/${{ matrix.svc }}/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache,mode=max

  dockerize-frontend:
    name: Build & Push frontend image
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Sanity check frontend layout
        run: |
          test -f "spring-microservices-bookstore-demo/frontend/Dockerfile" || { echo "Missing frontend/Dockerfile"; exit 1; }
          test -f "spring-microservices-bookstore-demo/frontend/package.json" || { echo "Missing frontend/package.json"; exit 1; }
          echo "Frontend layout OK"

      - name: Compute short SHA
        id: vars
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
          echo "sha_tag=sha-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build & Push frontend
        uses: docker/build-push-action@v6
        with:
          context: ./spring-microservices-bookstore-demo/frontend
          file: ./spring-microservices-bookstore-demo/frontend/Dockerfile
          push: true
          tags: |
            shpro123/frontend:latest
            shpro123/frontend:${{ steps.vars.outputs.sha_tag }}
          cache-from: type=registry,ref=shpro123/frontend:buildcache
          cache-to: type=registry,ref=shpro123/frontend:buildcache,mode=max
